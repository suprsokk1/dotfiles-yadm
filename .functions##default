# -*- mode: sh -*-

TRAPERR() {
    case $# in
        0) exit 1;; # !?
        *)
            case $@ in
                .check*)
                ;;
                *)
            esac
    esac
    # echo  -e ${FUNCNAME:+-n} "${FUNCNAME:+$FUNCNAME}"
}

for ITEM in aliases functions parameters; do
    function -list--$ITEM {
        eval "print -rl -- \${(k)${funcstack##*-}}"
    }
done

command_not_found_handle() {
    # test -f /etc/redhat-release
    exe="$1"
    basename=${1##*/}
    case $basename in
        tmux)
            pushd $(mktemp -d) || exit
            coproc nohup sudo dnf install --assumeyes tmux
            popd || exit
            ;;
        pup)
            # latest=(
            #     ['pup']='v0.4.0'
            # )
            # FIXME @latest TODO find latest stable version
            # go install github.com/ericchiang/pup@$latest['pup']
            go install github.com/ericchiang/pup@main
            ;;
        regex2json)
            go install gitlab.com/tozd/regex2json/cmd/regex2json@main
            ;;
        exa|fswatch|gotty|highlight|tar|fzf|fd|mako|rg|pass|lynis)
            tmux split -d sudo dnf install --assumeyes "$1"
            eval "$@"
            ;;
        yadm)
            brew install "$1"
            ;;
        *)
    esac
    eval "$@"

}

__get_longopt__tmux() {
    tmux capture-pane -p |
        sed -E '/[^[:space:]]/!d;s,.*~,,'
}


tidy() {
    command tr --delete '["]' |
        command tr --squeeze-repeats '[[:space:]]'
}


getPpid() {
    grep -Pioz '(?<=Ppid:).*' /proc/"${1:-$$}"/status |
        tr --delete '[[:space:]]'
}



set-theme---zsh() {
    command sed -E "/ZSH_THEME/d;iZSH_THEME=\"${@}\";N" ~/.zshrc
}


-list--files--fd() {
    eval "command stdbuf -oL /usr/bin/env --ignore-environment $(command -v fd) $@"
}

-list--unit-files() {
    command jc systemctl listt-unit-files |
        jq '.[]' -c
}

-list--env() {
    { env; set; } | LC_ALL jc --env  | jq -c '.[]'
}

-list--files--all() {
    -list--files--fd --one-file-system -uuu `# -X exa -l` . "${@:-$PWD}"
}

-list--files--git-repositories() {
    -list--files--fd --hidden -tf --glob config "${@:-$PWD}" |
        LC_ALL=C command rg --line-buffered -- '.git/config' |
        sed -E 's#..git.config$##' |
        command jc --ls |
        command jq -c '.[]'
}

-list--files.json() {
    -list--files--fd | command jc --ls  | jq '.[]' -c
}

-list--files--executable() {
    command fd --type f  -tx |
        command jc --ls  |
        jq '.[]' -c
}

-list--files--changed-today() {
    -list--files--fd --one-file-system --hidden --no-ignore-vcs --changed-within='1day' "${1:-.}" "${2:-$PWD}"
}

-list--yadm-files() {
    yadm list
}

-regex--files-at-level.3() {
    grep -Po -- '^/?(?:[^/]+\b){3}'
}

-list--yadm-files--untagged() {
    yadm list | sed '/#/d'
}

-dirnames() {
    command xargs --replace=FILES find FILES -maxdepth 0 -execdir pwd \;
}

-dirnames--uniq() {
    -dirnames | uniq
}

#    translate ls arguments to exa
#    mainly '-t' => '--time modified'
# FIXME
unalias ls &>/dev/null ||:
ls() {
    local exa
    exa=(--icons --group-directories-first)
    for arg; do
        if  [[ $arg =~ ^-- ]]; then
            exa+=("$arg")
        elif [[ $arg =~ ^-[a-zA-Z] ]]; then
            # split short options
            grep --extended-regexp --only-matching -- '[[:alpha:]]' <<< "${arg//-/}" |
                while read c ; do
                    case $c in
                        o)
                            # TODO
                            ;;
                        t)
                            # exa+=( "${arg//t/}" )
                            exa+=( --time modified )
                            ;;
                        G|-)
                            # discard
                            ;;
                        *)
                            exa+=( -"$c" )
                    esac
                done
        else
            exa+=("$arg")
        fi
    done
    eval "exa ${exa[@]}"
}


enumerate() {
    local i
    i=0
    # echo -en ' '
    case $# in
        0) return;;
        1)
            enumerate $(command grep -o . <<< "$1")
           ;;
        *)
            for arg; do
                printf '%2d %s\n' $((++i)) "$arg"
            done
    esac
}

when() {
    [[ $@ ]] || return 1
    exe="$1"
    if command -v "$exe" &>/dev/null
    then eval "$@"
    fi
}

__debug__() {
    set -x
    eval "$@"
    set +x
}

precmd() {
    eval "${PROMPT_COMMAND:+$PROMPT_COMMAND}"
}

__tmux_mpm_helper() {
    set $(tmux capture-pane -p | awk '/cargo|dnf|gem|yum/{print $2}')
    export dnf=("$@")
}

_files_tmux() {
    # (notify-send --expire-time 500 "$0" "$words" &>/dev/null)
    reply=( $(_capp | awk /'\.([ot]tf)$'/{print\ \$1}) )
    fonts=( $(_capp | awk /'\.([ot]tf)$'/{print\ \$1}) )
    files=( $(_capp | grep -Poz -- '/[\s\S]+/' | awk '{print $1}' ))

}

_refresh_arrays() {
    [[ $TMUX ]] || return 0
    _files_tmux
    return
    notify-send --expire-time 500 "$0" "$words" &>/dev/null
}

-match--ip-addresses() {
    command grep -Po -- "\b$(rgxg cidr 0.0.0.0/0)\b"
}

-subnets() {
    command ip -4 route |
        command grep -Po -- "$(rgxg cidr 0.0.0.0/0)/([1-3]?[0-9])"
}

-ip-addresses() {
    command ip -4 address show |
        command grep -Po -- "\b$(rgxg cidr 0.0.0.0/0)\b"
}

.check--() {
    TODO
}

-download-nerd-fonts() {
    curl --silent -- nerdfonts.com/downloads |
        pup 'a[href*="zip"]:contains("Download")' attr{href} | head -2 | xargs env -C /dev/shm curl --retry 2 --verbose --remote-name --progress-bar
}

-list--github-starred-repositories() {
    TODO
}

list() {
    TODO
}

_list() {
    TODO
}
