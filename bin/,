#!/usr/bin/env -S bash
# -*- mode: sh -*-
shopt -s extglob

PATH=${PATH:-${HOME}/bin:${PATH}}
DBUS_SESSION_BUS_ADDRESS=${DBUS_SESSION_BUS_ADDRESS:-unix:path=/run/user/${EUID}/bus}
WAYLAND_DISPLAY=${WAYLAND_DISPLAY:-wayland-1}

script="$(which $0|xargs realpath)"
ext=${1##*.}
functions=( "$(compgen -A function)" )
name=${0##*/}
realname=$(readlink "$name")
parent=$(readlink /proc/$PPID/exe)

if false; then
    yadm config --regex ${ext:-`date +%s`} >&2
fi


if [[ $DEBUG ]]; then
    notify-send --expire-time 100 ${@:-,}
fi

trap TRAPEXIT EXIT

TRAPEXIT() {
    rc=$?
    case $rc in
        0) __main__ ;;
        *)
    esac
}


function __main__ {
    shebang=$(head -1 "${@:-/dev/null}")
    notify-send --expire-time 1000 "$0" "$parent:$name:$*"

    case $name in
        SUDO_ASKPASS|sudo-askpass)
            pass local
            ;;

        ,)
            # if parent application call on ','
            case $parent in
                *alacritty*)
                # TODO
                ;;
                *ansible*)
                    echo "$@"
                    ;;
                *zsh*)
                    case $@ in
                        fswatch)
                            shift
                            fswatch -o "$1" `# Watchdir` \
                                --event Created \
                                --event Updated \
                                --event Removed \
                                --event Renamed \
                                --event OwnerModified \
                                --event AttributeModified \
                                --event MovedFrom \
                                --event MovedTo \
                                --exclude ".git" |
                                xargs --max-args --replace IGNORE ,
                            ;;
                        *)
                    esac
                    ;;

                *cron*)   ;;&
                *incron*) ;;
                *cronie*) ;;
                *fzf*)
                    # FIXME
                    case $# in
                        1)
                            # pcre_compile -m "$(yadm config --get regex.ansi)"
                            # pcre_match -b -- "$@"

                            if test -f "$1" || test -L "$1"
                            then
                                highlight -O ansi --force < "$1"

                            elif test -d "$1"
                            then
                                :

                            fi
                            ;;
                        *)
                    esac
                    ;;

                *fswatch*) `# TODO` ;;

                *emacs*)
                    case $shebang in
                        *python)
                            python "$@"
                            ;;
                        *)
                    esac

                    if isGit; then
                        echo $GIT_DIR
                    fi

                    case $@ in
                        *sway*)
                            sway -C && sway reload
                            echo RC:$?
                            ;;
                        *)
                    esac

                    case $ext in
                        js)         node "$1" ;;
                        org)        emacsclient --eval '(org-babel-execute-maybe)' ;;
                        sh)         eval "$1"; exit ;;
                        yml|yaml)   if grep -- '---' "$1" && grep -- '^- hosts:' "$_"; then
                                        runPlay "$1"
                                    fi
                            ;;

                        py) command emacsclient --eval '(run-python)'
                            command emacsclient --eval '(python-shell-send-file "'"$1"'")'
                            command emacsclient --eval '(+popup/toggle)'
                            ;;

                        nim)
                            nim c -r --verbosity:0 "$1"
                            ;;

                        rs)
                            PS4='${0}:${LINENO}: '
                            set -o errexit -o xtrace
                            pushd $(mktemp -d)
                            rustc "$1" -o out
                            ./out
                            ;;

                        *)
                    esac
                    ;;
                *)  test -x "$1" && grep -q -w -- 'bash' "$1" && eval "$1" && exit 0
                    case $ext in
                        sqlite) sqlite3 -line "$1" '.tables' ;;
                        *)
                    esac

            esac
            ;;
        *)
    esac

    case $# in
        [0-1])

        ;;
        *)
            exit
    esac

}


function isGit {
    git rev-parse --show-toplevel &>/dev/null
}


function runPlay {
    # export ANSIBLE_HOME=$HOME/ansible
    export ANSIBLE_STDOUT_CALLBACK=yaml
    export ANSIBLE_FORCE_COLOR=1
    export ANSIBLE_DEBUG=0
    export ANSIBLE_VERBOSITY=0
    # export ANSIBLE_
    # export ANSIBLE_INVENTORY=inventory/
    # export ANSIBLE_INVENTORY_PLUGIN_SCRIPT_STDERR=true
    # export ANSIBLE_CONFIG=ffs.cfg

    gitdir="${1%/*}"
    pushd "$gitdir"

    if pushd "$(git rev-parse --show-toplevel)"; then
        if test 1 -eq  $(yq '..|select(has("become")).become' "$1"); then
            pass _ansible/become | tee fifo > /dev/null &
            export ANSIBLE_PASSWORD_FILE=fifo
        fi
        ansible-playbook $(realpath --relative-base="$_" "$1")
        return
        # echo pwd: $PWD
    else
        ansible-playbook "$1"
    fi
}
