# .zshrc -*- mode: sh -*-

# force tmux to truncate lines
setterm --linewrap off
setterm --term

# FIXME tmux completion and maybe others
# TODO disable bell
# TODO disable all predefined static dirs
hash -d yadm=~/.config/yadm
hash -d run="${XDG_RUNTIME_DIR:-/run/user/${EUID:-$(id -u)}}"
hash -d config="${XDG_CONFIG_HOME:-~/.config}"
hash -d ram=~run
hash -d temp=~run
hash -d fonts=~/.local/share/fonts
hash -d autorun=~/.config/autorun
hash -d desktop=~/.local/share/applications

ZSH=~/.oh-my-zsh
ZSH_THEME="af-magic"

# plugins-=(pipenv)
plugins+=(zsh-autosuggestions)
plugins+=(git)
plugins+=(direnv)
plugins+=(fzf)

FZF_DEFAULT_OPTS="--layout=reverse --height=7"
FZF_DEFAULT_COMMAND=$HOME/bin/,

PROMPT_COMMAND=
if [[ ${(k)functions} =~ _refresh_completion ]]; then
PROMPT_COMMAND+="`# refresh completion options`_refresh_completion"
fi
PROMPT_COMMAND+='; . ~/.functions;. ~/.aliases'

if ! test -d ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
then git clone https://github.com/zsh-users/zsh-autosuggestions $_
fi

# activate oh-my-zsh
if [[ -s $ZSH/oh-my-zsh.sh  ]]; then
. $ZSH/oh-my-zsh.sh
fi

# ???
if [[ $TMUX ]] && (! [[ $TMUX_PANE ]]); then
if false; then
tmux source-file ~/.config/tmux/tmux.conf
__tmux_menu
fi
fi

if command -v incrontab &>/dev/null
then
:<<.incrontab.syntax
$$   dollar sign
$@   watched filesystem path (see above)
$#   event-related file name
$%   event flags (textually)
$&   event flags (numerically)
.incrontab.syntax
{ envsubst | incrontab - &>/dev/null; } <<'INCRONTAB'
PATH=${HOME}/bin:${PATH}
DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/${EUID}/bus
WAYLAND_DISPLAY=${WAYLAND_DISPLAY}

${HOME}       IN_CREATE,recursive=false    , $#
${HOME}/watch IN_ALL_EVENTS,recursive=true /usr/bin/notify-send --expire-time 5000 $# $%
INCRONTAB
fi

if false; then
source <(when jc --zsh-comp)
fi


# this must be the last file to load
if [[ -s ~/src/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
source ~/src/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

#
# completion
#

:<<.zstyle.syntax
$ zstyle :completion:<function>:<completer>:<command>:<argument>:<tag>
.zstyle.syntax

set - "${XDG_CACHE_HOME:-/run/user/${EUID:-$(id -u)}}/zsh/.zcompcache"
mkdir -p "$1"
zstyle ':completion:*' cache-path "$1"
shift
zstyle ':completion:*' use-cache on
zstyle ':completion:*' squeeze-slashes true

_piactl() {
    reply=( {,dis}connect )
}
compctl -K {_,}piactl

_vpn() {
    reply=(on off up down 0 1)
}
vpn() {
    case $1 in
        pause|hold|sleep)
            piactl
        ;;
        1|y|on|up)
            piactl connect
        ;;
        0|n|off|down)
            piactl disconnect
            ;;
        *)

    esac
}

compctl -K {_,}vpn

alias _nmap='_subnets'
